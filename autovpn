#!/bin/bash

# setup the regex pattern for checking vpn config file names
if [ -f "${props_file}" ] ; then
  source ${props_file}
else
  filename_pattern='^.+\.ovpn$'
fi

# Watch the Downloads directory for new VPN config files
inotifywait -mqe create --exclude ".*\.crdownload|\.org\.chromium\.Chromium\..*" "${HOME}/Downloads" |
  while read path event file
  do
    # Check if the file looks like a vpn config we want
    if [[ "${file}" =~ ${filename_pattern} ]]
    then
      # Get the VPN name
      vpn=`echo ${file} | awk -F '-' '{print $2}'`

      # Check if an old connection already exists
      cons=`ps -ef|grep "openvpn.*vpn-${vpn}-.*.ovpn"|grep -v grep|awk '{print $2}'`
      if [ -n "${cons}" ]
      then
        echo "Removing old '${vpn}' VPN connection..."
        kill ${cons}
      fi

      # Connect to the VPN
      echo "Connecting to the '${vpn}' VPN..."
      openvpn --config "${path}${file}" &
    fi
  done
